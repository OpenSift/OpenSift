services:
  opensift-gateway:
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: opensift-gateway
    ports:
      - "8001:8001"
    working_dir: /app
    user: "${OPENSIFT_UID:-0}:${OPENSIFT_GID:-0}"
    command: ["python", "opensift.py", "gateway", "--host", "0.0.0.0", "--port", "8001", "--with-mcp", "--health-timeout", "30"]
    env_file:
      - backend/.env
    environment:
      OPENSIFT_LOG_DIR: /app/.opensift_logs
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    tmpfs:
      - /tmp
    volumes:
      # Mount backend source/state so sessions, Chroma, auth, and SOUL persist.
      - ./backend:/app
    healthcheck:
      test:
        - CMD
        - python
        - -c
        - "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8001/health', timeout=5).read()"
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s
    restart: unless-stopped

  opensift-terminal:
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: opensift-terminal
    working_dir: /app
    user: "${OPENSIFT_UID:-0}:${OPENSIFT_GID:-0}"
    command: ["python", "opensift.py", "terminal", "--provider", "claude_code"]
    env_file:
      - backend/.env
    environment:
      OPENSIFT_LOG_DIR: /app/.opensift_logs
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    tmpfs:
      - /tmp
    volumes:
      - ./backend:/app
    depends_on:
      opensift-gateway:
        condition: service_healthy
    stdin_open: true
    tty: true
    profiles:
      - terminal
