<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>OpenSift Library</title>
    <style>
      :root {
        --bg: #f3f5f8;
        --panel: #ffffff;
        --panel-2: #f7f8fb;
        --text: #151a22;
        --muted: #6c7586;
        --line: #e4e8ef;
        --brand: #5aa8ff;
        --danger: #c13737;
      }
      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0;
        color: var(--text);
        font-family: "Manrope", "IBM Plex Sans", "Avenir Next", "Segoe UI", sans-serif;
        background:
          radial-gradient(900px 500px at -15% -20%, #e8f3ff 0%, transparent 60%),
          radial-gradient(850px 500px at 120% -10%, #e6eefc 0%, transparent 58%),
          linear-gradient(180deg, #f6f8fb 0%, #f1f4f8 100%);
      }
      .app {
        height: 100vh;
        display: grid;
        grid-template-columns: 340px 1fr;
      }
      .sidebar {
        border-right: 1px solid var(--line);
        background: linear-gradient(180deg, #fdfdfe, #f7f9fc);
        display: grid;
        grid-template-rows: auto auto auto auto auto 1fr auto;
        min-height: 0;
      }
      .section {
        padding: 12px 14px;
        border-bottom: 1px solid var(--line);
      }
      .brand { font-size: 17px; font-weight: 760; letter-spacing: .02em; }
      .stack { display: grid; gap: 8px; }
      .hint { font-size: 12px; color: var(--muted); }
      .main {
        min-width: 0;
        display: grid;
        grid-template-rows: auto auto 1fr;
      }
      .topbar {
        border-bottom: 1px solid var(--line);
        padding: 10px 14px;
        display: flex;
        gap: 8px;
        align-items: center;
        background: var(--panel);
      }
      .filters {
        border-bottom: 1px solid var(--line);
        padding: 10px 14px;
        display: grid;
        grid-template-columns: 1fr 160px 160px 180px 100px 100px 140px;
        gap: 8px;
      }
      .pagination {
        border-top: 1px solid var(--line);
        padding: 8px 14px;
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .content {
        min-height: 0;
        display: grid;
        grid-template-columns: 380px 1fr;
      }
      .list-pane {
        min-height: 0;
        overflow: auto;
        border-right: 1px solid var(--line);
        padding: 10px;
        display: grid;
        gap: 8px;
        align-content: start;
      }
      .item-card {
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 10px;
        background: var(--panel);
        box-shadow: 0 1px 2px rgba(20, 29, 43, 0.06);
      }
      .item-title { font-weight: 600; font-size: 13px; }
      .item-meta { font-size: 11px; color: var(--muted); margin-top: 4px; }
      .item-preview {
        margin-top: 6px;
        color: var(--muted);
        font-size: 12px;
        white-space: pre-wrap;
      }
      .item-actions {
        margin-top: 8px;
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }
      .details {
        min-height: 0;
        overflow: auto;
        padding: 14px;
      }
      .panel {
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 12px;
        background: var(--panel);
        box-shadow: 0 1px 2px rgba(20, 29, 43, 0.06);
      }
      .panel h3 { margin: 0 0 8px; font-size: 16px; }
      .panel-meta { font-size: 12px; color: var(--muted); margin: 2px 0; }
      .panel-text {
        margin-top: 10px;
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 10px;
        background: var(--panel-2);
        white-space: pre-wrap;
        line-height: 1.4;
        max-height: 60vh;
        overflow: auto;
        font-size: 13px;
      }
      .pdf-preview {
        margin-top: 10px;
        width: 100%;
        height: min(72vh, 780px);
        border: 1px solid var(--line);
        border-radius: 10px;
        background: #fff;
      }
      input, select, textarea, button { font: inherit; }
      input, select, textarea {
        width: 100%;
        color: #1e2430;
        border: 1px solid var(--line);
        border-radius: 10px;
        background: #fff;
        padding: 9px 10px;
      }
      textarea { min-height: 100px; resize: vertical; }
      button {
        border: 1px solid var(--line);
        border-radius: 10px;
        background: #fff;
        color: #1b2230;
        padding: 8px 10px;
        cursor: pointer;
      }
      button:hover { background: #f8fafc; }
      button.primary { background: linear-gradient(180deg, #68b2ff, #4f9dff); border-color: #438fe7; color: #fff; }
      button.danger { background: #fff1f1; border-color: #efb2b2; color: #9f2626; }
      .out {
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 9px;
        white-space: pre-wrap;
        font-size: 12px;
        color: var(--muted);
        background: var(--panel-2);
      }
      .pill {
        font-size: 11px;
        border: 1px solid var(--line);
        border-radius: 999px;
        padding: 6px 10px;
        color: var(--muted);
        background: #fff;
      }
      @media (max-width: 1100px) {
        .app { grid-template-columns: 1fr; }
        .content { grid-template-columns: 1fr; }
        .list-pane { border-right: none; border-bottom: 1px solid var(--line); max-height: 35vh; }
      }
    </style>
  </head>
  <body data-csrf="{{ csrf_token }}">
    <div class="app">
      <aside class="sidebar">
        <div class="section">
          <div class="brand">OpenSift</div>
          <div class="hint" style="margin-top:2px;">Gateway</div>
        </div>

        <div class="section stack">
          <div class="hint">Owner</div>
          <input id="owner" value="{{ owner }}" placeholder="bio101" />
          <label class="hint"><input id="allOwnersToggle" type="checkbox" /> Browse all owners</label>
          <input id="defaultFolder" placeholder="Default folder (optional)" />
          <input id="defaultTags" placeholder="Default tags (comma-separated)" />
          <div style="display:flex; gap:8px;">
            <button id="goChatBtn" type="button" class="primary" style="width:100%;">Back To Chat</button>
            <button id="refreshBtn" type="button" style="width:100%;">Refresh</button>
          </div>
        </div>

        <div class="section stack">
          <div class="hint">Save Note</div>
          <input id="noteTitle" placeholder="Title (optional)" />
          <textarea id="noteText" placeholder="Paste class notes, summaries, formulas, etc."></textarea>
          <button id="saveNoteBtn" type="button">Save Note</button>
        </div>

        <div class="section stack">
          <div class="hint">Save Article URL</div>
          <input id="urlTitle" placeholder="Title (optional)" />
          <input id="urlInput" placeholder="https://example.com/article" />
          <button id="saveUrlBtn" type="button">Fetch + Save URL</button>
        </div>

        <div class="section stack">
          <div class="hint">Upload File</div>
          <input id="fileTitle" placeholder="Title (optional)" />
          <input id="fileInput" type="file" />
          <button id="uploadBtn" type="button">Upload + Index</button>
          <progress id="uploadProgress" max="100" value="0" style="width:100%; height:14px;"></progress>
          <div class="hint" id="uploadMeta">Idle.</div>
        </div>

        <div class="section">
          <div class="out" id="actionOut">Library ready.</div>
        </div>
      </aside>

      <main class="main">
        <div class="topbar">
          <span class="pill">owner: <strong id="ownerLabel">{{ owner }}</strong></span>
          <span class="pill" id="countPill">0 items</span>
        </div>
        <div class="filters">
          <input id="searchInput" placeholder="Search title, preview, filename, URL..." />
          <select id="kindFilter">
            <option value="">All Types</option>
            <option value="note">Notes</option>
            <option value="url">Articles/URLs</option>
            <option value="pdf">PDFs</option>
            <option value="text">Text Files</option>
            <option value="image">Images</option>
            <option value="file">Files</option>
          </select>
          <select id="folderFilter">
            <option value="">All Folders</option>
          </select>
          <input id="tagsFilter" placeholder="Tags filter (comma-separated)" />
          <select id="sortBy">
            <option value="created_at">Sort: Newest</option>
            <option value="title">Sort: Title</option>
            <option value="kind">Sort: Type</option>
            <option value="text_chars">Sort: Size</option>
          </select>
          <select id="sortDir">
            <option value="desc">Desc</option>
            <option value="asc">Asc</option>
          </select>
          <button id="searchBtn" type="button">Search</button>
        </div>
        <div class="content">
          <section id="listPane" class="list-pane"></section>
          <section class="details">
            <div class="panel" id="detailsPanel">
              <h3>Select an item</h3>
              <div class="panel-meta">Choose a source to browse full text and metadata.</div>
            </div>
          </section>
        </div>
        <div class="pagination">
          <button id="prevPageBtn" type="button">Prev</button>
          <span class="hint" id="pageMeta">Page 1 / 1</span>
          <button id="nextPageBtn" type="button">Next</button>
          <label class="hint" for="pageSize">Page size</label>
          <select id="pageSize" style="width:90px;">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>
      </main>
    </div>

    <script>
      const csrfToken = document.body.dataset.csrf || "";
      const ownerEl = document.getElementById("owner");
      const ownerLabelEl = document.getElementById("ownerLabel");
      const countPillEl = document.getElementById("countPill");
      const listPaneEl = document.getElementById("listPane");
      const detailsPanelEl = document.getElementById("detailsPanel");
      const actionOutEl = document.getElementById("actionOut");

      const noteTitleEl = document.getElementById("noteTitle");
      const noteTextEl = document.getElementById("noteText");
      const urlTitleEl = document.getElementById("urlTitle");
      const urlInputEl = document.getElementById("urlInput");
      const fileTitleEl = document.getElementById("fileTitle");
      const fileInputEl = document.getElementById("fileInput");
      const uploadProgressEl = document.getElementById("uploadProgress");
      const uploadMetaEl = document.getElementById("uploadMeta");

      const searchInputEl = document.getElementById("searchInput");
      const kindFilterEl = document.getElementById("kindFilter");
      const folderFilterEl = document.getElementById("folderFilter");
      const tagsFilterEl = document.getElementById("tagsFilter");
      const sortByEl = document.getElementById("sortBy");
      const sortDirEl = document.getElementById("sortDir");
      const defaultFolderEl = document.getElementById("defaultFolder");
      const defaultTagsEl = document.getElementById("defaultTags");
      const prevPageBtn = document.getElementById("prevPageBtn");
      const nextPageBtn = document.getElementById("nextPageBtn");
      const pageMetaEl = document.getElementById("pageMeta");
      const pageSizeEl = document.getElementById("pageSize");
      const allOwnersToggleEl = document.getElementById("allOwnersToggle");

      let selectedItemId = "";
      let currentPage = 1;
      let totalPages = 1;
      let libraryItemCache = {};

      function csrfFetch(url, options = {}) {
        const headers = new Headers(options.headers || {});
        headers.set("X-CSRF-Token", csrfToken);
        return fetch(url, { ...options, headers });
      }

      async function ensureAuth(res) {
        if (res.status === 401 || res.status === 403) {
          window.location.href = "/login";
          return false;
        }
        return true;
      }

      async function openChatForOwner(ownerName) {
        const targetOwner = (ownerName || "").trim() || owner();
        try {
          const listRes = await fetch("/chat/session/list");
          if (await ensureAuth(listRes)) {
            let exists = false;
            if (listRes.ok) {
              const listData = await listRes.json().catch(() => ({}));
              const sessions = Array.isArray(listData.sessions) ? listData.sessions : [];
              exists = sessions.some((s) => String((s || {}).owner || "") === targetOwner);
            }
            if (!exists) {
              const form = new FormData();
              form.append("owner", targetOwner);
              const newRes = await csrfFetch("/chat/session/new", { method: "POST", body: form });
              await ensureAuth(newRes);
            }
          }
        } catch (_) {}
        window.location.href = `/chat?owner=${encodeURIComponent(targetOwner)}`;
      }

      function owner() {
        const raw = ownerEl.value.trim() || "default";
        const normalized = raw.replace(/[^a-zA-Z0-9._-]+/g, "_").slice(0, 128) || "default";
        ownerEl.value = normalized;
        ownerLabelEl.textContent = normalized;
        return normalized;
      }

      function setOut(text) {
        actionOutEl.textContent = text || "";
      }

      function fmtTs(ts) {
        if (!ts) return "";
        const d = new Date(ts);
        if (Number.isNaN(d.getTime())) return ts;
        return d.toLocaleString();
      }

      function escapeHtml(v) {
        return String(v || "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#39;");
      }

      async function loadLibraryList() {
        const o = owner();
        const q = searchInputEl.value.trim();
        const kind = kindFilterEl.value;
        const folder = folderFilterEl.value || "";
        const tags = tagsFilterEl.value.trim();
        const allOwners = allOwnersToggleEl.checked ? "true" : "false";
        const sortBy = sortByEl.value || "created_at";
        const sortDir = sortDirEl.value || "desc";
        const pageSize = pageSizeEl.value || "20";
        const u = `/chat/library/list?owner=${encodeURIComponent(o)}&all_owners=${encodeURIComponent(allOwners)}&q=${encodeURIComponent(q)}&kind=${encodeURIComponent(kind)}&folder=${encodeURIComponent(folder)}&tags=${encodeURIComponent(tags)}&sort_by=${encodeURIComponent(sortBy)}&sort_dir=${encodeURIComponent(sortDir)}&page=${encodeURIComponent(currentPage)}&page_size=${encodeURIComponent(pageSize)}`;
        const res = await fetch(u);
        if (!(await ensureAuth(res))) return;
        if (!res.ok) {
          setOut("Failed to load library items.");
          return;
        }
        const data = await res.json();
        const items = data.items || [];
        const pagination = data.pagination || {};
        const total = Number(pagination.total || 0);
        totalPages = Number(pagination.total_pages || 1);
        currentPage = Number(pagination.page || 1);
        pageMetaEl.textContent = `Page ${currentPage} / ${totalPages}`;
        prevPageBtn.disabled = currentPage <= 1;
        nextPageBtn.disabled = currentPage >= totalPages;
        countPillEl.textContent = `${total} item${total === 1 ? "" : "s"}`;
        const folders = data.folders || [];
        const previousFolder = folderFilterEl.value;
        folderFilterEl.innerHTML = '<option value="">All Folders</option>';
        for (const f of folders) {
          const opt = document.createElement("option");
          opt.value = f;
          opt.textContent = f;
          folderFilterEl.appendChild(opt);
        }
        if (previousFolder) folderFilterEl.value = previousFolder;
        renderItemList(items);
      }

      function renderItemList(items) {
        libraryItemCache = {};
        listPaneEl.innerHTML = "";
        if (!items.length) {
          listPaneEl.innerHTML = `<div class="hint">No items yet. Add notes, URLs, PDFs, images, or text files.</div>`;
          return;
        }
        for (const item of items) {
          libraryItemCache[item.id] = item;
          const isSelected = item.id === selectedItemId;
          const card = document.createElement("div");
          card.className = "item-card";
          if (isSelected) card.style.borderColor = "#5a76ff";

          const title = escapeHtml(item.title || "Untitled");
          const kind = escapeHtml(item.kind || "item");
          const created = fmtTs(item.created_at);
          const preview = escapeHtml(item.preview || "");
          const textChars = Number(item.text_chars || 0);
          const chunkCount = Number(item.chunk_count || 0);
          const hasBinary = !!(item.binary_path || "");
          const folder = escapeHtml(item.folder || "");
          const tags = escapeHtml(item.tags || "");
          const itemOwner = escapeHtml(item.owner || "");

          card.innerHTML = `
            <div class="item-title">${title}</div>
            <div class="item-meta">${kind} 路 ${textChars} chars 路 ${chunkCount} chunks</div>
            <div class="item-meta">${itemOwner ? `owner: ${itemOwner}` : "owner: (unknown)"}</div>
            <div class="item-meta">${folder ? `folder: ${folder}` : "folder: (none)"}</div>
            <div class="item-meta">${tags ? `tags: ${tags}` : "tags: (none)"}</div>
            <div class="item-meta">${escapeHtml(created)}</div>
            <div class="item-preview">${preview}</div>
            <div class="item-actions">
              <button type="button" data-action="open">Open</button>
              ${hasBinary ? `<button type="button" data-action="download">Download</button>` : ""}
              <button type="button" class="danger" data-action="delete">Delete</button>
            </div>
          `;

          card.querySelector('[data-action="open"]').addEventListener("click", () => openItem(item.id));
          if (hasBinary) {
            card.querySelector('[data-action="download"]').addEventListener("click", () => {
              const o = owner();
              window.open(
                `/chat/library/download?owner=${encodeURIComponent(o)}&item_owner=${encodeURIComponent(item.owner || o)}&item_id=${encodeURIComponent(item.id)}`,
                "_blank"
              );
            });
          }
          card.querySelector('[data-action="delete"]').addEventListener("click", async () => {
            const ok = confirm(`Delete '${item.title || item.id}'? This removes stored text and vectors.`);
            if (!ok) return;
            await deleteItem(item.id);
          });

          listPaneEl.appendChild(card);
        }
      }

      async function openItem(itemId) {
        selectedItemId = itemId;
        const o = owner();
        const cachedItem = libraryItemCache[itemId];
        const itemOwner = (cachedItem && cachedItem.owner) ? cachedItem.owner : o;
        const res = await fetch(`/chat/library/get?owner=${encodeURIComponent(o)}&item_owner=${encodeURIComponent(itemOwner)}&item_id=${encodeURIComponent(itemId)}`);
        if (!(await ensureAuth(res))) return;
        if (!res.ok) {
          setOut("Failed to load selected item.");
          return;
        }
        const data = await res.json();
        const detailItem = data.item || {};
        const text = data.text || "";
        renderItemDetails(detailItem, text);
        await loadLibraryList();
      }

      function renderItemDetails(item, text) {
        const hasBinary = !!(item.binary_path || "");
        const o = owner();
        const itemOwner = String(item.owner || o);
        const originalName = String(item.original_name || item.title || "").toLowerCase();
        const binaryPath = String(item.binary_path || "").toLowerCase();
        const isPdf = String(item.kind || "").toLowerCase() === "pdf" || originalName.endsWith(".pdf") || binaryPath.endsWith(".pdf");
        const previewUrl = `/chat/library/preview?owner=${encodeURIComponent(o)}&item_owner=${encodeURIComponent(itemOwner)}&item_id=${encodeURIComponent(item.id || "")}`;
        detailsPanelEl.innerHTML = `
          <h3>${escapeHtml(item.title || "Untitled")}</h3>
          <div class="panel-meta">Type: ${escapeHtml(item.kind || "")}</div>
          <div class="panel-meta">Owner: ${escapeHtml(itemOwner || "")}</div>
          <div class="panel-meta">Created: ${escapeHtml(fmtTs(item.created_at))}</div>
          <div class="panel-meta">Source URL: ${escapeHtml(item.url || "")}</div>
          <div class="panel-meta">Filename: ${escapeHtml(item.original_name || "")}</div>
          <div class="panel-meta">Folder: ${escapeHtml(item.folder || "(none)")}</div>
          <div class="panel-meta">Tags: ${escapeHtml(item.tags || "(none)")}</div>
          <div class="panel-meta">Text chars: ${Number(item.text_chars || 0)} 路 Chunks: ${Number(item.chunk_count || 0)}</div>
          <div style="display:grid; gap:8px; margin-top:10px;">
            <input id="editTitle" value="${escapeHtml(item.title || "")}" placeholder="Title" />
            <input id="editFolder" value="${escapeHtml(item.folder || "")}" placeholder="Folder" />
            <input id="editTags" value="${escapeHtml(item.tags || "")}" placeholder="Tags (comma-separated)" />
            <button id="saveMetaBtn" type="button">Save Metadata</button>
          </div>
          <div style="display:flex; gap:8px; margin-top:10px;">
            ${hasBinary ? `<button id="detailsDownloadBtn" type="button">Download Original</button>` : ""}
            <button id="detailsToChatBtn" type="button" class="primary">Ask From Chat</button>
          </div>
          ${isPdf && hasBinary ? `
            <object class="pdf-preview" data="${previewUrl}" type="application/pdf">
              <div class="hint" style="padding:12px;">
                PDF preview is not available in this browser.
                If you're using Safari with Lockdown Mode enabled, inline PDF previews can be blocked for this site.
                <a href="${previewUrl}" target="_blank" rel="noopener noreferrer">Open with Preview</a>
                or
                <a href="/chat/library/download?owner=${encodeURIComponent(o)}&item_owner=${encodeURIComponent(itemOwner)}&item_id=${encodeURIComponent(item.id || "")}" target="_blank" rel="noopener noreferrer">download it</a>.
              </div>
            </object>
          ` : ""}
          ${isPdf && hasBinary ? `<div class="hint" style="margin-top:8px;">PDF preview above. If the frame is blank, Safari Lockdown Mode may be blocking inline PDF rendering for this site. Use "Open with Preview" or disable Lockdown Mode for this site.</div>` : ""}
          <div class="panel-text">${escapeHtml(text || "(no text body found)")}</div>
        `;
        if (hasBinary) {
          document.getElementById("detailsDownloadBtn").addEventListener("click", () => {
            window.open(
              `/chat/library/download?owner=${encodeURIComponent(o)}&item_owner=${encodeURIComponent(itemOwner)}&item_id=${encodeURIComponent(item.id)}`,
              "_blank"
            );
          });
        }
        document.getElementById("detailsToChatBtn").addEventListener("click", () => {
          openChatForOwner(itemOwner);
        });
        document.getElementById("saveMetaBtn").addEventListener("click", async () => {
          const form = new FormData();
          form.append("owner", o);
          form.append("item_owner", itemOwner);
          form.append("item_id", item.id || "");
          form.append("title", (document.getElementById("editTitle").value || "").trim());
          form.append("folder", (document.getElementById("editFolder").value || "").trim());
          form.append("tags", (document.getElementById("editTags").value || "").trim());
          const res = await csrfFetch("/chat/library/update", { method: "POST", body: form });
          if (!(await ensureAuth(res))) return;
          const data = await res.json().catch(() => ({}));
          if (!res.ok || !data.ok) {
            setOut(`Save metadata failed: ${data.error || "unknown error"}`);
            return;
          }
          setOut("Metadata updated.");
          await openItem(item.id || "");
        });
      }

      async function deleteItem(itemId) {
        const item = libraryItemCache[itemId];
        const itemOwner = (item && item.owner) ? item.owner : owner();
        const form = new FormData();
        form.append("owner", owner());
        form.append("item_owner", itemOwner);
        form.append("item_id", itemId);
        const res = await csrfFetch("/chat/library/delete", { method: "POST", body: form });
        if (!(await ensureAuth(res))) return;
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          setOut(`Delete failed: ${data.error || "unknown error"}`);
          return;
        }
        if (selectedItemId === itemId) {
          selectedItemId = "";
          detailsPanelEl.innerHTML = `
            <h3>Select an item</h3>
            <div class="panel-meta">Choose a source to browse full text and metadata.</div>
          `;
        }
        setOut("Deleted item.");
        await loadLibraryList();
      }

      async function saveNote() {
        const text = noteTextEl.value.trim();
        if (!text) {
          setOut("Note is empty.");
          return;
        }
        const form = new FormData();
        form.append("owner", owner());
        form.append("title", noteTitleEl.value.trim());
        form.append("note", text);
        form.append("folder", defaultFolderEl.value.trim());
        form.append("tags", defaultTagsEl.value.trim());
        const res = await csrfFetch("/chat/library/note", { method: "POST", body: form });
        if (!(await ensureAuth(res))) return;
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.ok) {
          setOut(`Save note failed: ${data.error || "unknown error"}`);
          return;
        }
        noteTextEl.value = "";
        noteTitleEl.value = "";
        setOut(`Saved note: ${data.item?.title || "untitled"}`);
        await loadLibraryList();
      }

      async function saveUrl() {
        const rawUrl = urlInputEl.value.trim();
        if (!rawUrl) {
          setOut("URL is empty.");
          return;
        }
        const form = new FormData();
        form.append("owner", owner());
        form.append("title", urlTitleEl.value.trim());
        form.append("url", rawUrl);
        form.append("folder", defaultFolderEl.value.trim());
        form.append("tags", defaultTagsEl.value.trim());
        const res = await csrfFetch("/chat/library/url", { method: "POST", body: form });
        if (!(await ensureAuth(res))) return;
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.ok) {
          setOut(`Save URL failed: ${data.error || "unknown error"}`);
          return;
        }
        urlInputEl.value = "";
        urlTitleEl.value = "";
        setOut(`Saved URL: ${data.item?.title || rawUrl}`);
        await loadLibraryList();
      }

      function uploadWithProgress(url, formData) {
        return new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest();
          const started = Date.now();

          xhr.open("POST", url, true);
          xhr.setRequestHeader("X-CSRF-Token", csrfToken);

          xhr.upload.onprogress = (ev) => {
            if (!ev.lengthComputable || ev.total <= 0) return;
            const pct = Math.min(100, Math.round((ev.loaded / ev.total) * 100));
            uploadProgressEl.value = pct;

            const elapsedSec = Math.max(1, Math.floor((Date.now() - started) / 1000));
            const bytesPerSec = ev.loaded / elapsedSec;
            const remainSec = bytesPerSec > 0 ? Math.max(0, Math.ceil((ev.total - ev.loaded) / bytesPerSec)) : 0;
            uploadMetaEl.textContent = `Uploading ${pct}% 路 ${remainSec}s remaining`;
          };

          xhr.onload = () => {
            let payload = {};
            try { payload = JSON.parse(xhr.responseText || "{}"); } catch (_) {}
            resolve({ status: xhr.status, body: payload });
          };
          xhr.onerror = () => reject(new Error("upload_failed"));
          xhr.send(formData);
        });
      }

      async function uploadFile() {
        const f = fileInputEl.files && fileInputEl.files[0];
        if (!f) {
          setOut("Choose a file first.");
          return;
        }

        const form = new FormData();
        form.append("owner", owner());
        form.append("title", fileTitleEl.value.trim());
        form.append("folder", defaultFolderEl.value.trim());
        form.append("tags", defaultTagsEl.value.trim());
        form.append("file", f);

        uploadProgressEl.value = 0;
        uploadMetaEl.textContent = "Starting upload...";
        try {
          const result = await uploadWithProgress("/chat/library/upload", form);
          if (result.status === 401 || result.status === 403) {
            window.location.href = "/login";
            return;
          }
          if (result.status < 200 || result.status >= 300 || !result.body.ok) {
            const err = result.body.error || "unknown error";
            uploadMetaEl.textContent = "Failed.";
            setOut(`Upload failed: ${err}`);
            return;
          }
          uploadProgressEl.value = 100;
          uploadMetaEl.textContent = "Completed.";
          fileInputEl.value = "";
          fileTitleEl.value = "";
          setOut(`Uploaded and indexed: ${result.body.item?.title || f.name}`);
          await loadLibraryList();
        } catch (_) {
          uploadMetaEl.textContent = "Failed.";
          setOut("Upload failed due to network or browser error.");
        }
      }

      document.getElementById("goChatBtn").addEventListener("click", () => {
        window.location.href = `/chat?owner=${encodeURIComponent(owner())}`;
      });
      document.getElementById("refreshBtn").addEventListener("click", loadLibraryList);
      document.getElementById("saveNoteBtn").addEventListener("click", saveNote);
      document.getElementById("saveUrlBtn").addEventListener("click", saveUrl);
      document.getElementById("uploadBtn").addEventListener("click", uploadFile);
      document.getElementById("searchBtn").addEventListener("click", loadLibraryList);
      searchInputEl.addEventListener("keydown", (ev) => {
        if (ev.key === "Enter") {
          ev.preventDefault();
          loadLibraryList();
        }
      });
      kindFilterEl.addEventListener("change", loadLibraryList);
      allOwnersToggleEl.addEventListener("change", () => {
        currentPage = 1;
        loadLibraryList();
      });
      folderFilterEl.addEventListener("change", loadLibraryList);
      tagsFilterEl.addEventListener("keydown", (ev) => {
        if (ev.key === "Enter") {
          ev.preventDefault();
          currentPage = 1;
          loadLibraryList();
        }
      });
      sortByEl.addEventListener("change", () => {
        currentPage = 1;
        loadLibraryList();
      });
      sortDirEl.addEventListener("change", () => {
        currentPage = 1;
        loadLibraryList();
      });
      pageSizeEl.addEventListener("change", () => {
        currentPage = 1;
        loadLibraryList();
      });
      prevPageBtn.addEventListener("click", () => {
        if (currentPage <= 1) return;
        currentPage -= 1;
        loadLibraryList();
      });
      nextPageBtn.addEventListener("click", () => {
        if (currentPage >= totalPages) return;
        currentPage += 1;
        loadLibraryList();
      });
      ownerEl.addEventListener("change", loadLibraryList);

      loadLibraryList().catch(() => {
        setOut("Failed to load library on startup.");
      });
    </script>
  </body>
</html>
